name: Fork Sync

on:
  # 毎週日曜日の午前2時（UTC）に実行
  schedule:
    - cron: '0 2 * * 0'
  # 手動実行も可能
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/aws-samples/generative-ai-use-cases.git

    - name: Fetch upstream
      run: |
        git fetch upstream

    - name: Check for conflicts
      id: check
      run: |
        # 単純な競合チェック
        if git merge-tree $(git merge-base HEAD upstream/main) HEAD upstream/main | grep -q "^@@"; then
          echo "has_conflicts=true" >> $GITHUB_OUTPUT
          echo "⚠️ Potential conflicts detected"
        else
          echo "has_conflicts=false" >> $GITHUB_OUTPUT
          echo "✅ No conflicts detected"
        fi

    - name: Safe merge if no conflicts
      if: steps.check.outputs.has_conflicts == 'false'
      run: |
        git checkout main
        # .github/workflows/ を保護してマージ
        git merge upstream/main --no-edit
        git checkout HEAD -- .github/workflows/fork-sync.yml
        git add .github/workflows/fork-sync.yml
        git commit --amend --no-edit || true
        git push origin main

    - name: Create issue if conflicts detected
      if: steps.check.outputs.has_conflicts == 'true'
      run: |
        echo "Conflicts detected. Manual sync required."
        echo "Please manually merge upstream changes."
